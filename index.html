<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuruk Drive</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --main: #ff6b00; --dark: #111; --card: #1a1a1a; }
        body {margin:0; font-family:system-ui,sans-serif; background:var(--dark); color:white; min-height:100vh;}
        .container {max-width:420px; margin:0 auto; padding:20px;}
        .card {background:var(--card); border-radius:16px; padding:24px; margin:15px 0; box-shadow:0 8px 30px rgba(0,0,0,0.6);}
        h1 {text-align:center; color:var(--main); margin:0 0 10px; font-size:2.2em;}
        input, button {
            width:100%; padding:14px; margin:10px 0; border-radius:12px; border:none; font-size:17px; box-sizing:border-box;
        }
        input {background:#333; color:white;}
        button {background:var(--main); color:white; font-weight:bold; cursor:pointer;}
        button:active {transform:scale(0.98);}
        button.secondary {background:#444;}
        .orders {display:grid; gap:12px; margin-top:20px;}
        .order {background:#222; padding:16px; border-radius:12px; border-left:4px solid var(--main);}
        .status {font-size:0.9em; opacity:0.8;}
        .logo {font-size:3em; text-align:center; margin:20px 0;}
    </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

// ТВОИ КЛЮЧИ
const supabase = window.supabase.createClient(
  'https://fprhprgmdmtgjpokzpyp.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwcmhwcmdtZG10Z2pwb2t6cHlwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNDcyNDksImV4cCI6MjA4MDYyMzI0OX0.LFq94eKUDJWAfFZlPrnvbKZbtQI1dP-cAHRDUNiRcgs'
);

function App() {
  const [phone, setPhone] = useState('');
  const [code, setCode] = useState('');
  const [user, setUser] = useState(null);
  const [view, setView] = useState('login'); // login | verify | choose_role | dashboard | order
  const [orders, setOrders] = useState([]);

  // Автологин
  useEffect(() => {
    supabase.auth.getSession().then(({ data: { session } }) => {
      if (session) initUser(session.user);
    });

    const { data: listener } = supabase.auth.onAuthStateChange((_, session) => {
      if (session) initUser(session.user);
      else { setUser(null); setView('login'); setOrders([]); }
    });

    return () => listener.subscription.unsubscribe();
  }, []);

  const initUser = async (authUser) => {
    let { data: profile } = await supabase.from('profiles').select('role').eq('id', authUser.id).single();
    
    if (!profile) {
      setUser(authUser);
      setView('choose_role');
      return;
    }

    setUser({ ...authUser, role: profile.role });
    setView('dashboard');
    loadOrders(profile.role, authUser.id);
  };

  const loadOrders = async (role, userId) => {
    let query = supabase.from('orders').select('*').order('created_at', { ascending: false });
    if (role === 'passenger') query = query.eq('passenger_id', userId);
    else if (role === 'driver') query = query.eq('status', 'pending');

    const { data } = await query;
    setOrders(data || []);
  };

  const sendSMS = async () => {
    const clean = phone.replace(/[^\d+]/g, '');
    if (!clean.match(/^\+7\d{10}$/)) return alert('Введите номер в формате +77001234567');

    const { error } = await supabase.auth.signInWithOtp({ phone: clean });
    if (error) alert('Ошибка: ' + error.message);
    else {
      alert('Код отправлен на ' + clean);
      setPhone(clean);
      setView('verify');
    }
  };

  const verifySMS = async () => {
    const { error } = await supabase.auth.verifyOtp({
      phone: phone,
      token: code,
      type: 'sms'
    });
    if (error) alert('Неверный код: ' + error.message);
  };

  const chooseRole = async (role) => {
    await supabase.from('profiles').insert({ id: user.id, role });
    setUser({ ...user, role });
    setView('dashboard');
    loadOrders(role, user.id);
  };

  const createOrder = async (from, to) => {
    await supabase.from('orders').insert({
      passenger_id: user.id,
      from_address: from,
      to_address: to,
      status: 'pending'
    });
    alert('Заказ создан!');
    loadOrders(user.role, user.id);
    setView('dashboard');
  };

  const acceptOrder = async (id) => {
    await supabase.from('orders').update({
      status: 'accepted',
      driver_id: user.id
    }).eq('id', id);
    loadOrders(user.role, user.id);
  };

  const logout = () => supabase.auth.signOut();

  // === ЭКРАНЫ ===
  if (view === 'login')
    return (
      <div className="container">
        <div className="logo">Kuruk Drive</div>
        <div className="card">
          <h1>Kuruk Drive</h1>
          <input placeholder="+77001234567" value={phone} onChange={e=>setPhone(e.target.value)} />
          <button onClick={sendSMS}>Получить код</button>
        </div>
      </div>
    );

  if (view === 'verify')
    return (
      <div className="container">
        <div className="card">
          <h2>Введите код из SMS</h2>
          <input placeholder="123456" value={code} onChange={e=>setCode(e.target.value)} />
          <button onClick={verifySMS}>Войти</button>
          <button className="secondary" onClick={()=>setView('login')}>Назад</button>
        </div>
      </div>
    );

  if (view === 'choose_role')
    return (
      <div className="container">
        <div className="card">
          <h2>Кем вы будете в Kuruk Drive?</h2>
          <button onClick={()=>chooseRole('passenger')} style={{background:'#4CAF50', margin:'10px 0'}}>Пассажир</button>
          <button onClick={()=>chooseRole('driver')} style={{background:'#ff9800'}}>Водитель</button>
        </div>
      </div>
    );

  // Дашборд
  return (
    <div className="container">
      <div className="logo">Kuruk Drive</div>
      <div className="card">
        <p>Вы: {user.role === 'driver' ? 'Водитель' : 'Пассажир'}</p>
        <button onClick={logout} className="secondary">Выйти</button>

        <div className="orders">
          {orders.length === 0 && <p>Пока нет заказов</p>}
          {orders.map(o => (
            <div key={o.id} className="order">
              <b>От:</b> {o.from_address}<br/>
              <b>К:</b> {o.to_address}<br/>
              <span className="status">Статус: {o.status === 'pending' ? 'Ждёт водителя' : 'В работе'}</span>
              {user.role === 'driver' && o.status === 'pending' && 
                <button onClick={()=>acceptOrder(o.id)} style={{marginTop:10, background:'#4CAF50'}}>Принять заказ</button>
              }
            </div>
          ))}
        </div>

        {user.role === 'passenger' && 
          <button onClick={()=>setView('order')} style={{marginTop:20}}>+ Новый заказ</button>
        }
      </div>

      {view === 'order' && (
        <div className="card" style={{marginTop:20}}>
          <h2>Куда едем?</h2>
          <input id="from" placeholder="Откуда (например: Курык центр)" />
          <input id="to" placeholder="Куда (например: Актау)" />
          <button onClick={()=>{
            const from = document.getElementById('from').value;
            const to = document.getElementById('to').value;
            if(from && to) createOrder(from, to);
          }}>Заказать такси</button>
          <button className="secondary" onClick={()=>setView('dashboard')}>Отмена</button>
        </div>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
